<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Konum Alıcı — Tarayıcıdan Doğrudan Konum</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; margin:0; background:#0b1220; color:#e8f0f8; display:flex; min-height:100vh}
    .panel{width:420px; padding:20px; box-sizing:border-box; background:linear-gradient(180deg,#071426,#061427); border-right:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{margin:0 0 12px;color:#9fb3d6}
    label{display:block;margin-top:10px;font-size:13px;color:#9fb3d6}
    button,input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit;margin-top:8px}
    .row{display:flex;gap:8px}
    .small{width:120px}
    .meta{margin-top:14px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;font-family:monospace;white-space:pre-wrap}
    .map-wrap{flex:1;display:flex;flex-direction:column}
    #map{flex:1;min-height:320px}
    .footer{padding:12px 18px;background:#061427;font-size:13px;border-top:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
    .muted{color:#9fb3d6;font-size:13px}
    .success{color:#9adea8}
    .error{color:#ff9b9b}
    @media(max-width:900px){.panel{width:100%}body{flex-direction:column}.map-wrap{height:60vh}}
  </style>
</head>
<body>
  <aside class="panel">
    <h1>Konum Alıcı</h1>
    <p class="lead">Tarayıcıdan doğrudan konum alır. Kullanıcıdan izin ister. Konum yalnızca tarayıcıda görünür — sunucuya otomatik gönderilmez (isteğe bağlı gönderme eklenebilir).</p>

    <label>Konum Modu</label>
    <select id="mode">
      <option value="single">Tek seferlik (getCurrentPosition)</option>
      <option value="watch">Sürekli takip (watchPosition)</option>
    </select>

    <div class="row">
      <button id="start">Başlat</button>
      <button id="stop">Durdur</button>
    </div>

    <button id="copyJson">Konum JSON Kopyala</button>
    <button id="download">Konum JSON İndir</button>

    <div class="meta" id="meta">Durum: Hazır</div>
    <div style="margin-top:10px" class="muted">Not: Tarayıcı izin penceresi çıkar. İzin vermezsen konum alınamaz.</div>
  </aside>

  <main class="map-wrap">
    <div id="map"></div>
    <div class="footer">Durum: <span id="status">Beklemede</span> <span id="coords" style="margin-left:12px"></span></div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const modeSel = document.getElementById('mode');
    const meta = document.getElementById('meta');
    const status = document.getElementById('status');
    const coordsLabel = document.getElementById('coords');
    const copyBtn = document.getElementById('copyJson');
    const downloadBtn = document.getElementById('download');

    let watchId = null;
    let lastPosition = null;

    // Leaflet
    const map = L.map('map', {attributionControl:false}).setView([39.0,35.0],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
    let marker = null;

    function setStatus(s, cls){ status.textContent = s; if(cls) status.className = cls; }
    function updateMeta(pos){
      lastPosition = pos;
      const j = {
        timestamp: pos.timestamp,
        coords: {
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude,
          accuracy: pos.coords.accuracy,
          altitude: pos.coords.altitude,
          altitudeAccuracy: pos.coords.altitudeAccuracy,
          heading: pos.coords.heading,
          speed: pos.coords.speed
        }
      };
      meta.textContent = JSON.stringify(j, null, 2);
      coordsLabel.textContent = `Lat: ${j.coords.latitude.toFixed(5)}, Lon: ${j.coords.longitude.toFixed(5)} (±${j.coords.accuracy} m)`;

      // map marker
      if(marker) map.removeLayer(marker);
      marker = L.circleMarker([j.coords.latitude, j.coords.longitude], {radius:8, color:'#6ee79a', fillColor:'#6ee79a', fillOpacity:0.9}).addTo(map).bindPopup('Cihaz konumu');
      map.setView([j.coords.latitude, j.coords.longitude], 13);
    }

    function handleError(err){
      setStatus('Konum hatası: ' + err.message, 'error');
      meta.textContent = 'Hata: ' + err.message;
    }

    startBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ setStatus('Tarayıcı konum API desteklemiyor', 'error'); return; }
      const mode = modeSel.value;
      setStatus('İzin isteniyor...');
      if(mode === 'single'){
        navigator.geolocation.getCurrentPosition(pos => {
          setStatus('Konum alındı ✅', 'success');
          updateMeta(pos);
        }, err => { handleError(err); }, { enableHighAccuracy:true, timeout:10000 });
      } else {
        if(watchId !== null) { setStatus('Zaten takip ediliyor'); return; }
        watchId = navigator.geolocation.watchPosition(pos => {
          setStatus('Konum güncellendi ✅', 'success');
          updateMeta(pos);
        }, err => { handleError(err); }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
        setStatus('Sürekli takip başlatıldı — izin verildiğinde konum güncellenecek');
      }
    });

    stopBtn.addEventListener('click', ()=>{
      if(watchId !== null){ navigator.geolocation.clearWatch(watchId); watchId = null; setStatus('Takip durduruldu'); }
      else setStatus('Aktif takip yok');
    });

    copyBtn.addEventListener('click', ()=>{
      if(!lastPosition) return setStatus('Kopyalanacak konum yok', 'error');
      navigator.clipboard.writeText(meta.textContent).then(()=> setStatus('Konum JSON panoya kopyalandı')).catch(()=> setStatus('Kopyalama başarısız', 'error'));
    });

    downloadBtn.addEventListener('click', ()=>{
      if(!lastPosition) return setStatus('İndirilecek konum yok', 'error');
      const blob = new Blob([meta.textContent], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'konum.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      setStatus('Konum JSON indirildi');
    });

    // küçük uyarı: kullanıcı açıkça izin vermeli
    window.addEventListener('load', ()=>{
      setStatus('Hazır — Başlamak için "Başlat" a bas');
    });
  </script>
</body>
</html>